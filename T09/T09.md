### Các bước tạo VPC
- VPC
- Internet gateway
- Route Table (public)
- Subnet (public)
- Liên kết Subnet với Route Table

- Elastic IP 
- Subnet (private)
- NAT gateway gán elastic IP
- Route Table (private)
- Liên kết Subnet với Route Table

### Tạo VPC (Virtual private cloud)
VPC là mạng ảo nội bộ, nó là một vùng chứa toàn bộ các service của ta. Mặc định mỗi region của AWS sẽ có 1 VPC mặc định là `default`. Để tạo mới VPC, sử dụng resource `aws_vpc`
```
resource "aws_vpc" "my_vpc" {
  cidr_block = "10.0.0.0/16"
  enable_dns_hostnames = true
  tags = {
    name = "custom"
  }
}
```
Tham số `cidr_block` để set địa chỉ IPv4. Vì là private IP nên giá trị sẽ nằm trong các dải sau đây
- 10.0.0.0/8 - 10.255.255.255 (10.0.0.0/8)
- 172.16.0.0 - 172.31.255.255 (172.16.0.0/12)
- 192.168.0.0 - 192.168.255.255 (192.168.0.0/16)

Mỗi VPC sẽ chỉ thuộc 1 region.

Region là khu vực địa lý chứa nhiều data center. Không thể chuyển các service và data từ region này sang region khác được. Để chạy được ở các region khác, ta buộc phải tạo mới service, data.

Mỗi region sẽ có nhiều Availability Zones (AZ). Đây là các vị trí địa lý mà AWS đặt cơ sở hạ tầng. Các AZ kết nối với nhau để đồng bộ dữ liệu. Trong trường hợp 1 AZ bị down, thì các AZ khác vẫn hoạt động bình thường.

=> Xây dựng VPC chạy trên các AZ để đảm bảo downtime là thấp nhất.

### Tạo Subnet
Subnet Là đơn vị chia nhỏ hơn của VPC, là vùng chứa các service hoạt động. Tác dụng của subnet là để nhóm các service lại với nhau và cô lập các nhóm service khác.

Mỗi subnet phải nằm hoàn toàn trong 1 Availability Zone và không thể kéo dài tới các zone khác

Khi tạo một AWS instance thì bắt buộc phải chọn subnet cho nó, một subnet có thể chứa nhiều instance và một instance chỉ thuộc một subnet và một khi đã gắn một instance vào một subnet thì ta không thể chuyển nó sang subnet khác, chỉ có thể xóa instance đó và tạo lại ở subnet khác

![markdown](https://images.viblo.asia/32488ec2-2929-442c-b658-8a822d31ef37.png)
```
resource "aws_subnet" "private_subnet_2a" {
  vpc_id = aws_vpc.my_vpc.id
  cidr_block = "10.0.1.0/24"
  availability_zone = "us-west-2a"
  tags = {
    "name" = "private-subnet"
  }
}
```
Subnet có 2 loại: private và public. 
- Các serive chạy trong private subnet thì có thể gửi yêu cầu với bên ngoài internet nhưng bên ngoài lại không thể gửi ngược lại service.
- Các service chạy trong public subnet thì có thể tương tác 2 chiều với bên ngoài internet.

Ví dụ: Trong VPC có server và database. Các server sẽ được public ra ngoài internet => đặt trong public subnet. Các database thì không được truy cập từ internet, mà chỉ có thể truy cập từ server => đặt trong private subnet

### Internet gateway
Để các service bên trong public subnet có thể giao tiếp với ngoài internet, ta cần `internet gateway`. Sau đó là `route table` liên kết với gateway.

![markdown](https://images.viblo.asia/full/cd422d9c-e4ef-493e-bfc2-e000668a92eb.jpg)

```
resource "aws_internet_gateway" "gw" {
  vpc_id = aws_vpc.my_vpc.id
  tags = {
    "Name" = "custom"
  }
}

resource "aws_route_table" "public" {
  vpc_id = aws_vpc.my_vpc.id
  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.gw.id
  }
  tags = {
    "Name" = "public"
  }
}
```
Các `subnet` muốn kết nối với internet thì sẽ gán IP subnet vào table này
```
resource "aws_route_table_association" "public_router" {
  for_each = [ for v in aws_subnet.public_subnet.id: v.id ]
  subnet_id = each.value
  route_table_id = aws_route_table.public.id
}
```
![markdown](https://images.viblo.asia/0fe2595a-acca-4e55-8cae-5c6aa8ed4027.jpg)

### NAT gateway
Các service trong private subnet muốn kết nối internet để update phần mềm, nhưng lại không muốn internet truy cập ngược lại => Sử dụng NAT gateway

Có 2 loại NAT gateway: public NAT và private NAT.
Với loại public thì gateway sẽ được đặt trong 1 `public subnet` và được cấp phát 1 Elastic IP. Gateway này sẽ liên kết tới `route table` khác.
![markdown](https://images.viblo.asia/bb0564cc-f693-4ee4-b4bd-04b3e7e3234a.jpg)
```
resource "aws_eip" "eip" {
  vpc = true
}

resource "aws_nat_gateway" "public" {
  subnet_id = aws_subnet.private_subnet[0].id
  tags = {
    "name" = "nat"
  }
  depends_on = [aws_internet_gateway.gw]
}

resource "aws_route_table" "private" {
  vpc_id = aws_vpc.my_vpc.id
  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_nat_gateway.public.id
  }
  tags = {
    "name" = "private"
  }
}
```
Các private subnet muốn kết nối 1 chiều ra ngoài internet thì gán IP subnet vào table này.
```
resource "aws_route_table_association" "private_router" {
  for_each = { for k, v in aws_subnet.private_subnet: k => v }
  subnet_id =  each.value.id
  route_table_id = aws_route_table.private
}
```
